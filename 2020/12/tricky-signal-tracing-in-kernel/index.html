<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="more or less insightful">
    
    <link rel="shortcut icon" href="https://www.ooseel.net/me/favicon.ico">
    
    <link rel="stylesheet" href="/me/css/style.min.css">

    <title>Tricky Signal Tracing in Kernel</title>
    
</head>
<body><header id="banner">
    <h2><a href="https://www.ooseel.net/me/">more or less insightful</a></h2>
    <nav>
        <ul>
            
            <li>
                <a href="/me/" title="posts">posts</a>
            </li>
            
            <li>
                <a href="https://github.com/memnoth" title="github">github</a>
            </li>
            
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>Tricky Signal Tracing in Kernel</h1><time>December 12, 2020</time></header><p>Have you ever experienced such horrible signaling between core processes which might crash a whole system. This article is about an approach let you be safe from enermies. It&rsquo;d be good for both linux distros we mainly use in laptops and embedded systems. but more comfy on the latter for a test.</p>
<p>Someone says &ldquo;Better safe than sorry&rdquo;. I like that quote. Even though software world is totally chaotic on bugs, we should at least try some approaches being safe. Especially the signals. That could quietly stab your back one day if you are off the guard.</p>
<p>Our softwares are running on <strong>a</strong> software. we call it as Operating System. If we can read its code, modify as we want, why not put our idea into it? Let me say more straight, &ldquo;Let&rsquo;s hook the code where signals walk inside kernel.&rdquo;</p>
<p>For our goal, specify some wishes. I am going to make this more simple and they are only three. But you can do whatever you want. Anyway, I only wanna see all signals&rsquo; &hellip;</p>
<ol>
<li>Sender&rsquo;s name/pid</li>
<li>Signal&rsquo;s number</li>
<li>Receiver&rsquo;s name/pid</li>
</ol>
<h2 id="practice-time">Practice! time</h2>
<p>Signal processing has three stages in simple saying.</p>
<ol>
<li>kill syscall or from kernel</li>
<li>Ready to singal</li>
<li>Wake up the target process</li>
</ol>
<p>We are going to hook at the last of the second stage. Because most exceptions, for example <em>dereferencing NULL pointers</em> are already considered at the boundary between the second and third.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* kernel/signal.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__send_signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">kernel_siginfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
                         <span class="k">enum</span> <span class="n">pid_type</span> <span class="n">type</span><span class="p">,</span>
                         <span class="kt">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">sigpending</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sigqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">override_rlimit</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

  <span class="cm">/* ... A LOT CODE HERE ... */</span>

  <span class="n">complete_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">ret</span><span class="p">:</span>
  <span class="n">trace_signal_generate</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">PIDTYPE_PID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span> 
<span class="p">}</span>
</code></pre></div><p>Here&rsquo;s one of functions signals walk and as the callee&rsquo;s name <code>complete_signal</code> gives a big clue, hook points are its ahead/behind. I pick <em>ahead</em>.</p>
<p>Let&rsquo;s inject our idea now</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* kernel/signal.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__send_signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">kernel_siginfo</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
                         <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
                         <span class="k">enum</span> <span class="n">pid_type</span> <span class="n">type</span><span class="p">,</span>
                         <span class="kt">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">struct</span> <span class="n">sigpending</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sigqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">override_rlimit</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

  <span class="cm">/* ... A LOT CODE HERE ... */</span>

  <span class="cm">/* Our code! */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">!=</span> <span class="mi">17</span> <span class="o">&amp;&amp;</span> <span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">srcpid</span><span class="p">,</span> <span class="n">dstpid</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">src</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
    <span class="kt">char</span> <span class="n">dst</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span> <span class="n">cur_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">srcpid</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">si_pid</span><span class="p">;</span>
      <span class="n">cur_task</span> <span class="o">=</span> <span class="n">find_task_by_vpid</span><span class="p">(</span><span class="n">srcpid</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">srcpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just for kernel case */</span>

    <span class="n">dstpid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">cur_task</span> <span class="o">?</span> <span class="n">cur_task</span><span class="o">-&gt;</span><span class="nl">comm</span> <span class="p">:</span> <span class="s">&#34;kernel&#34;</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;lsahn signal tracing :: (%s %d) --[%d]--&gt; (%s %d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">srcpid</span><span class="p">,</span>
        <span class="n">sig</span><span class="p">,</span>
        <span class="n">dst</span><span class="p">,</span> <span class="n">dstpid</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">complete_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">ret</span><span class="p">:</span>
  <span class="n">trace_signal_generate</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">PIDTYPE_PID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>There are two type of sender, <code>SI_USER</code> and <code>SI_KERNEL</code>. <em>force</em> is set to <code>false</code> or <code>true</code> respectively. According to that, <code>cur_task</code> has current process&rsquo;s info or being NULL so that we finally decide sender&rsquo;s name. Also, ignore <code>SIGCHLD(17)</code> used for a signal notification to its parent that itself is exited.</p>
<h2 id="ta-da-with-dmesg">Ta-da! with dmesg</h2>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">root@OpenWrt:/# reboot
<span class="o">[</span>   56.365579<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>reboot 1286<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>procd 1<span class="o">)</span>
<span class="o">[</span>   56.452796<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>hostapd 705<span class="o">)</span>
<span class="o">[</span>   56.460590<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>wpa_supplicant 706<span class="o">)</span>
<span class="o">[</span>   56.504500<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>killall 1350<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>dropbear 597<span class="o">)</span>
<span class="o">[</span>   56.551519<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>odhcpd 822<span class="o">)</span>
<span class="o">[</span>   56.599167<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>logd 430<span class="o">)</span>
<span class="o">[</span>   56.701690<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>netifd 766<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>udhcpc 1044<span class="o">)</span>
<span class="o">[</span>   56.728474<span class="o">]</span> br-wan: port 1<span class="o">(</span>eth0<span class="o">)</span> entered disabled state
<span class="o">[</span>   56.738012<span class="o">]</span> device eth0 left promiscuous mode
<span class="o">[</span>   56.743576<span class="o">]</span> br-wan: port 1<span class="o">(</span>eth0<span class="o">)</span> entered disabled state
<span class="o">[</span>   56.769219<span class="o">]</span> smsc95xx 1-1.1:1.0 eth0: hardware isn<span class="err">&#39;</span>t capable of remote wakeup
<span class="o">[</span>   57.730085<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>ubusd 141<span class="o">)</span>
<span class="o">[</span>   57.737611<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>askfirst 143<span class="o">)</span>
<span class="o">[</span>   57.745295<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>urngd 177<span class="o">)</span>
<span class="o">[</span>   57.752705<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>brcmf_wdog/mmc1 293<span class="o">)</span>
<span class="o">[</span>   57.760934<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>dnsmasq 534<span class="o">)</span>
<span class="o">[</span>   57.768427<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>netifd 766<span class="o">)</span>
<span class="o">[</span>   57.775770<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>ntpd 1070<span class="o">)</span>
<span class="o">[</span>   57.782966<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>sh 1476<span class="o">)</span>
<span class="o">[</span>   57.790105<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>ntpd 1070<span class="o">)</span> --<span class="o">[</span>15<span class="o">]</span>--&gt; <span class="o">(</span>ntpd 1070<span class="o">)</span>
<span class="o">[</span>   57.790712<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>kernel 0<span class="o">)</span> --<span class="o">[</span>1<span class="o">]</span>--&gt; <span class="o">(</span>askfirst 143<span class="o">)</span>
<span class="o">[</span>   58.791265<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>procd 1<span class="o">)</span> --<span class="o">[</span>9<span class="o">]</span>--&gt; <span class="o">(</span>ash 142<span class="o">)</span>
<span class="o">[</span>   58.799449<span class="o">]</span> lsahn signal tracing :: <span class="o">(</span>kernel 0<span class="o">)</span> --<span class="o">[</span>1<span class="o">]</span>--&gt; <span class="o">(</span>ash 142<span class="o">)</span>
</code></pre></div><h2 id="this-one-vs-strace-vs-ftrace">This one vs. strace vs. ftrace</h2>
<p><code>ftrace</code> is a cool feature, really awesome! No doubt. I love it so much. But in case you cannot build it because of your manager..? or you&rsquo;d like to trace from the early stage of booting to the end.<br>
<code>strace</code> traces only one at a time. That means you have to execute it as many as you&rsquo;d like to trace. <strong>NOT</strong> the whole system.</p>
<p>This is a rough idea rather than bad article like &ldquo;this one is better than others&rdquo;. I hope you get inspired a lot and would be happy if someone has good ideas more than mine, then please email me :-)</p>
<p>Stay safe!</p>
</article>

        </main><footer id="footer">
    Copyright © 2020 Leesoo Ahn
</footer>
</body>
</html>
